<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AwaFrontend</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
  
  <!-- Widget ElevenLabs -->
  <elevenlabs-convai agent-id="agent_01k0p4gvgaffpb08wtt3662eq5"></elevenlabs-convai>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
  
  <script>
    // Mapping agenti
    const AGENT_MAPPING = {
      '/': 'agent_01k0p4gvgaffpb08wtt3662eq5',
      '/contatti': 'agent_01k0p4gvgaffpb08wtt3662eq5',
      '/formazione': 'agent_01k0p4gvgaffpb08wtt3662eq5',
      '/amministrazione': 'agent_01k0p4m8djec1a8ey5gy2r8eg1',
      '/commerciale': 'agent_01k0p4m8djec1a8ey5gy2r8eg1',
      '/uffici': 'agent_01k0p4m8djec1a8ey5gy2r8eg1',
      '/servizi': 'agent_01k0p91577erdb3zbsdfsyhehr',
      '/prodotti': 'agent_01k0p91577erdb3zbsdfsyhehr'
    };

    function switchAgent(newRoute) {
      console.log('üîÑ Switching agent for route:', newRoute);
      
      let agentId = AGENT_MAPPING['/'];  // Default
      
      for (const [route, agent] of Object.entries(AGENT_MAPPING)) {
        if (newRoute === route || newRoute.startsWith(route + '/')) {
          agentId = agent;
          break;
        }
      }
      
      console.log('ü§ñ Selected agent:', agentId);
      
      const widget = document.querySelector('elevenlabs-convai');
      if (widget && widget.getAttribute('agent-id') !== agentId) {
        widget.setAttribute('agent-id', agentId);
        console.log('‚úÖ Agent switched to:', agentId);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ DOM loaded, initializing widget...');
      
      const widget = document.querySelector('elevenlabs-convai');
      if (widget) {
        console.log('üì± Widget found');
        
        // Setup client tools
        widget.addEventListener('elevenlabs-convai:call', (event) => {
          console.log('üîß Setting up client tools...');
          
          event.detail.config.clientTools = {
            redirectToExternalURL: ({ url }) => {
              console.log('üöÄ redirectToExternalURL called with:', url);
              
              if (url && url.startsWith('/')) {
                console.log('üìç Internal navigation to:', url);
                
                // Cambia agente PRIMA di navigare
                switchAgent(url);
                
                // Aspetta un momento per il cambio agente
                setTimeout(() => {
                  // Usa Angular Router attraverso l'evento
                  window.history.pushState({}, '', url);
                  window.dispatchEvent(new PopStateEvent('popstate'));
                  console.log('‚úÖ Navigation completed to:', url);
                }, 100);
              } else if (url) {
                console.log('üåê External navigation to:', url);
                window.open(url, '_blank', 'noopener,noreferrer');
              }
            },
          };
        });

        // Switch agente iniziale
        switchAgent(window.location.pathname);
      } else {
        console.error('‚ùå Widget not found');
      }
    });
  </script>
</body>
</html>